<html>
<head>
<title>interactiveL</title>
<style>
.wrapper {float:left; }
</style>
<script src="Notation.js"></script>
<script src="RuleInput.js"></script>
<script src="DesignView.js"></script>
<script src="PreView.js"></script>
<script>

var system;
var design;
var previews = new Array();

var ruleInputs = new Array();

    window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       || 
              window.webkitRequestAnimationFrame || 
              window.mozRequestAnimationFrame    || 
              window.oRequestAnimationFrame      || 
              window.msRequestAnimationFrame     || 
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

function addAxiomInput() {
	var container = document.getElementById("ruleContainer");
	var id = ruleInputs.length;
	var div = document.createElement('div');
	div.innerHTML = '<label for="rule_' + id + '">Axiom: <input id="rule_' + id + '" type="text" size="10"></input></label>';
	container.appendChild( div );
	
	ruleInputs[id] = new RuleInput(document.getElementById("rule_" + id), system,
		function( tokens ) {
			// setExpression
			system.setAxiom( tokens );
		},
		function() {
			// getExpression
			return system.axiom;
		});
}

function addRuleInput( token, desc ) {
	var container = document.getElementById("ruleContainer");
	var id = ruleInputs.length;
	var div = document.createElement('div');
	div.innerHTML = '<label for="rule_' + id + '">' + getTokenChar(token) + ' → <input id="rule_' + id + '" type="text" size="20"></input><i>' + desc + '</i></label>';
	container.appendChild( div );
	
	ruleInputs[id] = new RuleInput(document.getElementById("rule_" + id), system,
		function( tokens ) {
			// setExpression
			system.setRule( token, tokens );
		},
		function() {
			// getExpression
			return system.rules[token];
		});
}

function addPreview(iter) {
	var container = document.getElementById("previewContainer");
	var id = previews.length;
	var wrapperDiv = document.createElement('div');
	wrapperDiv.className = "wrapper";
	wrapperDiv.innerHTML =
		'<canvas id="preview_' + id + '" width="200" height="200" style="border:1px solid #aaaaaa;"></canvas>' +
		'<div id="info_' + id + '">_' + id + '</div>';
	container.appendChild(wrapperDiv);
	previews[id] = new PreView(
		document.getElementById('preview_' + id),
		document.getElementById('info_' + id),
		system, iter);
}

function onLoad() {
	var vertices = [];
	vertices.push(new Vertice(50, 30));
	vertices.push(new Vertice(150, 30));
	vertices.push(new Vertice(150, 130));

	var lines = [];
	lines.push(new Line(vertices[0], vertices[1]));
	lines.push(new Line(vertices[1], vertices[2]));
	
	system = new System(document.getElementById("status"));

	// Dragon curve
	system.setAxiom([Tokens.F, Tokens.X]);
	// X → X + Y F + 
	system.setRule(Tokens.X, [
		Tokens.X,
		Tokens.LEFT,
		Tokens.Y,
		Tokens.F,
		Tokens.LEFT,
	]);
	// Y → - F X - Y 
	system.setRule(Tokens.Y, [
		Tokens.RIGHT,
		Tokens.F,
		Tokens.X,
		Tokens.RIGHT,
		Tokens.Y,
	]);

	design = new DesignView(document.getElementById("design"), document.getElementById("angleDeg"), vertices, lines, system);
	vertices = new Array();
	lines = new Array();

	addAxiomInput();
	var drawForward = "Draw forward";
	var noDrawing = "-";
	addRuleInput( Tokens.F, drawForward );
	addRuleInput( Tokens.G, drawForward );
	addRuleInput( Tokens.H, drawForward );
	addRuleInput( Tokens.X, noDrawing );
	addRuleInput( Tokens.Y, noDrawing );
	addRuleInput( Tokens.Z, noDrawing );
	
	addPreview(0);
	addPreview(1);
	addPreview(2);
	addPreview(4);
	addPreview(7);
	addPreview(10);
	
	// -X + X - X  - X + X
	
	frame();
}

function frame() {
	requestAnimFrame(frame);
	
	system.frame();
	design.frame();

	for (var i = 0 ; i < previews.length ; i++) {
		previews[i].frame();
	}

	for (var i = 0 ; i < ruleInputs.length ; i++) {
		ruleInputs[i].frame();
	}
}

</script>
</head>
<body onLoad="onLoad()">
<div id="designPanel">
	<canvas id="design" width="200" height="200" style="border:1px solid #aaaaaa; float:left;"></canvas>
	<div style="padding-left:10px; float:left">
		<p id="angle">
			<span>angle = </span>
			<span id="angleDeg">90°</span>
			<input type="button" id="a90" value="π / 2 | 90°"></input>
		</p>
		<p>+ : turn left</p>
		<p>- : turn right</p>
		<p>[ : push angle and position to stack</p>
		<p>] : pop angle and position from stack</p>
		<p id="ruleContainer"></p>
	</div>
</div>

<div style="float:left">
	<p id="previewContainer"></p>
	<p>&nbsp;</p>
	<div id="status"></div>
</div>

<div height="300" style="position:absolute; bottom:0">
<a href="https://github.com/Sverik/interactiveL">code at GitHub</a>
</div>
</body>
</html>
